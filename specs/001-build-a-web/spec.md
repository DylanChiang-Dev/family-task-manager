# Feature Specification: 家庭協作任務管理系統

**Feature Branch**: `001-build-a-web`
**Created**: 2025-01-09
**Status**: Draft
**Input**: User description: "Build a web application that helps a family manage tasks collaboratively. Users can create, edit, and complete tasks, assign tasks to specific family members, and set due dates with notifications. Tasks can be grouped by category or priority and viewed in list or calendar format. Completed tasks are tracked, and all changes sync across devices in real-time."

## Clarifications

### Session 2025-01-09

- Q: 任務刪除權限控制 - 誰可以刪除任務？ → A: 任務創建者可刪除自己創建的任務，團隊管理員（admin 角色）可刪除任何任務
- Q: 已完成任務的可見性與管理 - 已完成的任務如何處理？ → A: 完成後立即移至單獨的「已完成」標籤頁，與進行中任務分離
- Q: 類別（Category）的作用域 - 類別由誰創建和管理？ → A: 僅團隊管理員可創建類別，所有成員共享使用

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 創建和管理個人任務 (Priority: P1)

家庭成員需要快速記錄日常待辦事項，包括設置截止日期、優先級和負責人。這是任務管理的核心功能，所有其他功能都建立在此基礎上。

**Why this priority**: 這是 MVP 的核心價值主張。沒有任務的創建、編輯和完成功能，系統將無法提供任何實際價值。這是用戶第一次使用系統時必須立即能夠完成的基本操作。

**Independent Test**: 用戶註冊登錄後，創建一個任務（例如「購買牛奶」），設置截止日期為明天，優先級為「高」，分配給自己，然後在完成後標記為已完成。整個流程無需其他功能支持即可驗證。

**Acceptance Scenarios**:

1. **Given** 用戶已登錄系統，**When** 點擊「新建任務」按鈕並填寫任務標題「購買雜貨」，**Then** 系統創建新任務並顯示在任務列表頂部
2. **Given** 任務列表中存在未完成任務，**When** 用戶點擊任務標題進入編輯模式修改內容，**Then** 系統保存變更並更新顯示內容
3. **Given** 任務已創建，**When** 用戶設置截止日期為「2025-01-15」並選擇優先級為「高」，**Then** 系統顯示紅色優先級標記和截止日期倒計時
4. **Given** 任務處於「待處理」狀態，**When** 用戶點擊「標記為完成」按鈕，**Then** 系統將任務移至「已完成」列表並顯示完成時間戳
5. **Given** 用戶在任務詳情頁面，**When** 點擊「刪除任務」按鈕並確認刪除，**Then** 系統從列表中移除該任務

---

### User Story 2 - 團隊管理與任務分配 (Priority: P2)

家庭成員需要將任務分配給特定成員，查看自己被分配的任務，並了解其他成員的任務進度。這支持家庭分工協作。

**Why this priority**: 協作是「家庭任務管理」的核心差異化功能。單人任務管理工具已經很多，多用戶協作能力是本系統的獨特價值。這個故事建立在 P1 基礎上，需要先有任務 CRUD 功能。

**Independent Test**: 兩個用戶（媽媽和爸爸）登錄系統，媽媽創建任務「接孩子放學」並分配給爸爸，爸爸登錄後看到被分配的任務，完成後標記完成，媽媽能看到任務狀態變更。

**Acceptance Scenarios**:

1. **Given** 用戶創建新任務，**When** 在「分配給」下拉菜單中選擇家庭成員「爸爸」，**Then** 系統將任務分配給該成員並在任務卡片上顯示成員頭像
2. **Given** 用戶登錄系統，**When** 查看任務列表，**Then** 系統默認顯示「分配給我的任務」視圖，並可切換到「我創建的任務」或「所有任務」
3. **Given** 任務被分配給其他成員，**When** 該成員完成任務，**Then** 任務創建者看到任務狀態自動更新為「已完成」
4. **Given** 用戶在任務詳情頁面，**When** 修改「分配給」字段，**Then** 系統重新分配任務並通知新負責人
5. **Given** 多個任務存在，**When** 用戶點擊成員篩選器選擇「爸爸」，**Then** 系統僅顯示分配給爸爸的任務

---

### User Story 3 - 日曆視圖與截止日期管理 (Priority: P3)

家庭成員需要在日曆中查看任務的截止日期分佈，快速了解本週或本月的任務安排，避免遺漏重要截止日期。

**Why this priority**: 日曆視圖提供任務的時間維度可視化，幫助用戶更好地規劃時間。這是「Nice to have」功能，列表視圖已經可以滿足基本需求，但日曆能顯著提升用戶體驗。

**Independent Test**: 用戶創建 3 個任務，分別設置截止日期為本週一、週三、週五，切換到日曆視圖，驗證任務正確顯示在對應日期格子中，點擊日期可查看當天所有任務。

**Acceptance Scenarios**:

1. **Given** 用戶在任務列表視圖，**When** 點擊頂部「日曆視圖」切換按鈕，**Then** 系統顯示月曆並在相應日期格子中顯示任務圓點標記
2. **Given** 日曆視圖已打開，**When** 用戶點擊某個日期格子，**Then** 系統在右側面板顯示該日所有任務的詳細列表
3. **Given** 用戶在日曆視圖中，**When** 點擊「上一月」或「下一月」按鈕，**Then** 系統切換到對應月份並顯示該月所有任務
4. **Given** 任務截止日期為今天，**When** 日曆視圖渲染，**Then** 系統在今天日期格子中以紅色高亮顯示任務數量
5. **Given** 用戶在日曆某日期點擊「新建任務」，**Then** 系統打開任務創建表單並自動填充該日期為截止日期

---

### User Story 4 - 優先級與分類管理 (Priority: P4)

家庭成員需要按優先級（高/中/低）標記任務，並按類別（家務、購物、財務等）組織任務，以便快速找到相關任務。

**Why this priority**: 這是任務組織和過濾的增強功能。雖然有助於提升效率，但不是 MVP 的核心功能。用戶可以先使用基本的任務列表，後續再添加分類能力。

**Independent Test**: 用戶創建 5 個任務，為其中 2 個設置優先級為「高」、1 個為「中」、2 個為「低」，然後創建「家務」和「購物」兩個類別，將任務分配到不同類別，最後使用優先級篩選器僅顯示「高優先級」任務。

**Acceptance Scenarios**:

1. **Given** 用戶創建新任務，**When** 在優先級下拉菜單中選擇「高」，**Then** 系統在任務卡片左側顯示紅色優先級條
2. **Given** 團隊管理員在設置頁面，**When** 點擊「添加類別」按鈕輸入「家務」並保存，**Then** 系統創建新類別，所有團隊成員可在創建任務時選擇該類別
3. **Given** 任務列表包含多個優先級任務，**When** 用戶點擊「按優先級排序」按鈕，**Then** 系統按「高 → 中 → 低」順序重新排列任務
4. **Given** 用戶在左側類別導航欄，**When** 點擊「購物」類別，**Then** 系統僅顯示屬於該類別的任務
5. **Given** 任務已設置類別，**When** 用戶編輯任務修改類別為「財務」，**Then** 系統更新類別並在類別列表中重新歸類

---

### User Story 5 - 任務通知與提醒 (Priority: P5)

家庭成員需要在任務即將到期時收到提醒通知，避免遺漏重要任務。通知應支持瀏覽器推送和郵件提醒。

**Why this priority**: 通知系統是任務管理的重要增值功能，但實施複雜度較高（需要郵件服務器、推送服務等基礎設施）。可以在 MVP 驗證後再添加，初期可以使用簡單的瀏覽器彈窗提醒。

**Independent Test**: 用戶創建任務並設置截止日期為 1 小時後，啟用「到期提醒」選項，1 小時後系統發送瀏覽器推送通知和郵件提醒，用戶收到通知並可點擊通知直接打開任務詳情。

**Acceptance Scenarios**:

1. **Given** 用戶創建任務並設置截止日期，**When** 勾選「到期前 24 小時提醒」選項，**Then** 系統在截止日期前 24 小時發送通知
2. **Given** 任務分配給其他成員，**When** 分配完成，**Then** 系統向被分配成員發送「新任務分配」通知
3. **Given** 用戶打開瀏覽器通知權限，**When** 任務到期時間到達，**Then** 系統彈出瀏覽器推送通知顯示任務標題和剩餘時間
4. **Given** 用戶設置了郵箱地址，**When** 任務到期前 1 小時，**Then** 系統發送郵件提醒包含任務詳情和快捷鏈接
5. **Given** 用戶在設置頁面，**When** 選擇「靜音通知」選項，**Then** 系統停止發送所有通知直到用戶重新啟用

---

### User Story 6 - 實時數據同步 (Priority: P6)

家庭成員在不同設備（手機、平板、電腦）登錄時，任務變更需要自動同步到所有設備，確保數據一致性。

**Why this priority**: 實時同步是現代 Web 應用的標準期望，但技術實現複雜（需要 WebSocket 或輪詢機制）。可以先使用「刷新頁面同步」的簡單方案，後續升級到實時推送。

**Independent Test**: 用戶在電腦上創建任務「買菜」，同時在手機上打開同一賬號，無需刷新頁面，手機端自動顯示新創建的任務。用戶在手機上標記任務完成，電腦端立即看到狀態變更。

**Acceptance Scenarios**:

1. **Given** 用戶在設備 A 創建新任務，**When** 設備 B 處於打開狀態，**Then** 設備 B 在 3 秒內自動顯示新任務（無需刷新頁面）
2. **Given** 用戶在設備 A 編輯任務內容，**When** 設備 B 同時查看該任務，**Then** 設備 B 實時更新任務內容並提示「已更新」
3. **Given** 兩個設備同時編輯同一任務，**When** 保存時發生衝突，**Then** 系統提示「任務已被修改，請重新加載」並顯示最新版本
4. **Given** 用戶在設備 A 刪除任務，**When** 設備 B 正在顯示該任務，**Then** 設備 B 自動從列表中移除該任務並提示「任務已刪除」
5. **Given** 網絡連接中斷，**When** 用戶在離線狀態下修改任務，**Then** 系統暫存變更並在網絡恢復後自動同步

---

### Edge Cases

- **並發編輯衝突**: 當兩個用戶同時編輯同一任務時，如何處理數據衝突？（使用樂觀鎖定機制，最後保存者需要手動解決衝突）
- **任務截止日期過期**: 已過期但未完成的任務如何顯示？（在列表頂部以紅色警告樣式顯示，日曆視圖中標記為「逾期」）
- **大量任務加載**: 當用戶創建超過 1000 個任務時，如何優化性能？（實施分頁加載或虛擬滾動，每次加載 50 條）
- **通知轟炸**: 用戶設置 10 個任務同時到期，如何避免通知過多？（合併通知，顯示「您有 10 個任務即將到期」）
- **離線操作**: 用戶在飛機上離線創建任務，著陸後如何同步？（使用 LocalStorage 緩存，網絡恢復後自動上傳）
- **任務循環依賴**: 任務 A 依賴任務 B，任務 B 依賴任務 A，如何檢測並防止？（當前規格不包含任務依賴功能，未來添加時需實施循環檢測）
- **用戶移除後的任務歸屬**: 當家庭成員離開團隊，其創建或分配的任務如何處理？（提示管理員重新分配或歸檔這些任務）
- **時區差異**: 家庭成員分佈在不同時區，任務截止時間如何處理？（服務器統一使用 UTC，客戶端轉換為用戶本地時間顯示）

---

## Requirements *(mandatory)*

### Functional Requirements

#### 任務管理核心功能

- **FR-001**: 系統必須允許已登錄用戶創建新任務，包含標題（必填）、描述（可選）、截止日期（可選）、優先級（低/中/高，默認中）、分配成員（默認創建者）
- **FR-002**: 系統必須允許用戶編輯任務的所有屬性（標題、描述、截止日期、優先級、分配成員、狀態）
- **FR-003**: 系統必須允許任務創建者刪除自己創建的任務，團隊管理員（admin 角色）可刪除團隊內任何任務，刪除前需要確認對話框防止誤操作
- **FR-004**: 系統必須提供任務狀態管理，支持「待處理」、「進行中」、「已完成」、「已取消」四種狀態
- **FR-005**: 系統必須記錄任務的創建時間、最後修改時間、完成時間（若已完成）

#### 用戶與權限管理

- **FR-006**: 系統必須支持用戶註冊（郵箱 + 密碼）和登錄（Session 會話管理）
- **FR-007**: 系統必須支持多團隊架構，用戶可創建或加入多個家庭團隊（使用 6 位邀請碼）
- **FR-008**: 系統必須在每個團隊內嚴格隔離數據，用戶僅能查看和操作當前所屬團隊的任務
- **FR-009**: 系統必須提供團隊成員列表功能，顯示所有成員的暱稱和頭像
- **FR-010**: 系統必須允許用戶切換當前活動團隊（頂部下拉菜單）

#### 任務組織與過濾

- **FR-011**: 系統必須支持按優先級（高/中/低）標記任務，並使用顏色視覺區分（紅/黃/綠）
- **FR-012**: 系統必須支持任務分類功能，僅團隊管理員（admin 角色）可創建和管理自定義類別（如「家務」、「購物」、「財務」），所有團隊成員可在創建任務時選擇使用這些類別
- **FR-013**: 系統必須提供任務篩選功能，支持按狀態、優先級、分配成員、類別、截止日期範圍篩選
- **FR-014**: 系統必須提供任務排序功能，支持按創建時間、截止日期、優先級、最後修改時間排序

#### 視圖與界面

- **FR-015**: 系統必須提供列表視圖，顯示任務的標題、狀態、優先級、分配成員、截止日期，默認顯示進行中任務（待處理、進行中狀態）
- **FR-015a**: 系統必須提供「已完成」標籤頁，已完成任務在狀態變更為「已完成」後立即移至該標籤頁，與進行中任務分離顯示
- **FR-016**: 系統必須提供日曆視圖，在月曆格子中顯示任務圓點標記（僅顯示進行中任務），點擊日期可查看當天任務詳情
- **FR-017**: 系統必須支持響應式設計，在移動端（<640px）隱藏日曆，桌面端（≥1024px）並排顯示日曆和任務列表
- **FR-018**: 系統必須支持深色模式，自動檢測系統偏好（prefers-color-scheme）並允許手動切換

#### 通知與提醒

- **FR-019**: 系統應支持任務到期提醒，用戶可選擇提醒時間（截止前 24 小時、1 小時、自定義）[路線圖]
- **FR-020**: 系統應在任務被分配時通知被分配成員 [路線圖]
- **FR-021**: 系統應在任務狀態變更時通知任務創建者和相關成員 [路線圖]
- **FR-022**: 系統應支持瀏覽器推送通知（Web Push API），在用戶授權後發送通知 [路線圖]
- **FR-023**: 系統應支持郵件通知（SMTP），用戶可在設置中配置郵箱地址 [路線圖]

**註記**: 通知功能計劃在 v1.1.0 版本中實施，當前版本（v1.0.0）專注於核心任務管理和團隊協作功能。

#### 數據同步與持久化

- **FR-024**: 系統必須在用戶修改任務後立即保存到數據庫，確保數據不丟失
- **FR-025**: 系統必須實現數據同步機制
  - **階段 1 (MVP)**: 手動刷新機制，用戶點擊刷新按鈕更新數據
  - **階段 2 (v1.1.0)**: 輪詢機制，每 30 秒檢查數據更新
  - **階段 3 (v2.0.0)**: WebSocket 實時推送，3 秒內自動同步
- **FR-026**: 系統必須處理並發編輯衝突，使用樂觀鎖定機制（`updated_at` 時間戳比對）
- **FR-027**: 系統必須支持離線操作，在網絡中斷時緩存用戶操作，恢復連接後自動同步
- **FR-028**: 系統必須記錄任務歷史變更，支持查看「誰在何時修改了什麼」（審計日誌）

#### 安全與隱私

- **FR-029**: 系統必須使用 bcrypt 算法（cost=10）加密存儲用戶密碼，禁止明文存儲
- **FR-030**: 系統必須防止 SQL 注入攻擊，所有數據庫操作使用 PDO 預處理語句
- **FR-031**: 系統必須防止 XSS 攻擊，所有用戶輸入在輸出前使用 `htmlspecialchars()` 轉義
- **FR-032**: 系統必須驗證用戶權限，僅允許團隊成員訪問該團隊的任務數據
- **FR-033**: 系統必須在會話超時（24 小時無活動）後自動登出用戶

#### 安裝與部署

- **FR-XXX**: 系統必須提供 WordPress 風格的 4 步驟 Web 安裝向導
  - 步驟 1：環境檢查（PHP 8.3+、PDO 擴展、文件權限）
  - 步驟 2：數據庫配置（MySQL 5.7.44+ 連接測試、保存配置）
  - 步驟 3：管理員創建（用戶名、密碼、團隊名稱）
  - 步驟 4：安裝完成（創建數據表、生成鎖定文件）

#### 性能與可擴展性

- **FR-034**: 系統必須在任務數量超過 100 條時實施虛擬滾動或分頁加載，避免性能下降
- **FR-035**: 系統必須在 3 秒內加載並渲染任務列表（網絡延遲不計）
- **FR-036**: 系統必須支持至少 1000 個並發用戶同時在線而不出現性能降級

---

### Key Entities

- **用戶（User）**: 代表系統的註冊用戶
  - 屬性: 用戶名（郵箱）、暱稱、密碼哈希、頭像 URL、當前活動團隊 ID、創建時間
  - 關係: 一個用戶可屬於多個團隊（多對多），一個用戶可創建多個任務（一對多）

- **團隊（Team）**: 代表家庭或工作組
  - 屬性: 團隊名稱、6 位邀請碼、創建者 ID、創建時間
  - 關係: 一個團隊有多個成員（多對多），一個團隊有多個任務（一對多）

- **團隊成員（TeamMember）**: 用戶與團隊的關聯關係
  - 屬性: 團隊 ID、用戶 ID、角色（admin/member）、加入時間
  - 關係: 多對多中間表

- **任務（Task）**: 代表待辦事項
  - 屬性: 標題、描述、創建者 ID、分配成員 ID、團隊 ID、優先級、狀態、截止日期、類別 ID、任務類型（normal/recurring/repeatable）、週期配置（JSON）、創建時間、修改時間、完成時間
  - 關係: 屬於一個團隊（多對一），屬於一個類別（多對一），由一個用戶創建（多對一），分配給一個用戶（多對一）

- **類別（Category）**: 任務的分類標籤
  - 屬性: 類別名稱、團隊 ID、創建者 ID（必須是團隊管理員）、顏色標記、創建時間
  - 關係: 屬於一個團隊（多對一），包含多個任務（一對多）
  - 權限: 僅團隊管理員可創建和刪除類別，所有成員可查看和使用

- **通知（Notification）**: 系統發送的提醒消息
  - 屬性: 接收用戶 ID、通知類型（到期提醒/分配通知/狀態變更）、關聯任務 ID、通知內容、是否已讀、創建時間
  - 關係: 發送給一個用戶（多對一），關聯一個任務（多對一）

- **任務歷史（TaskHistory）**: 任務變更審計日誌
  - 屬性: 任務 ID、操作用戶 ID、操作類型（創建/編輯/刪除/狀態變更）、變更內容（JSON）、操作時間
  - 關係: 屬於一個任務（多對一），由一個用戶操作（多對一）

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶可在 30 秒內完成註冊並創建第一個任務（從打開網站到任務創建完成）
- **SC-002**: 系統支持至少 1000 個並發用戶同時在線，任務列表加載時間不超過 3 秒
- **SC-003**: 90% 的用戶在首次使用時無需查看幫助文檔即可成功創建和完成任務
- **SC-004**: 任務在一個設備上變更後，其他已登錄設備在 3 秒內自動同步更新（實時同步功能上線後）
- **SC-005**: 通知送達率達到 95% 以上（到期提醒、分配通知在設定時間的 1 分鐘內成功發送）[v1.1.0 功能目標]
- **SC-006**: 用戶在移動端和桌面端的任務完成率分別達到 70% 和 80%（完成任務數 / 創建任務數）
- **SC-007**: 系統在處理 10000 個任務的團隊時，列表渲染和篩選操作響應時間不超過 1 秒
- **SC-008**: 數據同步衝突率低於 1%（並發編輯導致的衝突次數 / 總編輯次數）
- **SC-009**: 用戶平均每週活躍天數達到 5 天（表明系統成為日常習慣工具）
- **SC-010**: 新用戶 7 日留存率達到 60% 以上（註冊後 7 天內至少登錄 1 次的用戶比例）

---

## Assumptions

為了推進規格制定，我們做出以下合理假設：

1. **用戶設備**: 假設用戶使用現代瀏覽器（Chrome/Firefox/Safari/Edge 最新版本），支持 HTML5、CSS3、JavaScript ES6+
2. **網絡環境**: 假設用戶擁有穩定的互聯網連接（至少 3G 速度），離線功能為增強功能
3. **團隊規模**: 假設每個家庭團隊平均 3-5 名成員，最多不超過 20 名成員
4. **任務數量**: 假設每個團隊平均創建 100-500 個任務，系統需支持最多 10000 個任務
5. **數據保留**: 假設已完成任務永久保存，未完成任務無過期刪除策略
6. **時區**: 假設所有用戶使用服務器本地時區（UTC），客戶端轉換為用戶本地時間（未來功能）
7. **郵件服務**: 假設系統使用標準 SMTP 服務發送郵件通知（需配置郵件服務器）
8. **認證方式**: 假設使用郵箱 + 密碼認證，不支持 OAuth2 或 SSO（可作為未來功能）
9. **文件上傳**: 假設當前版本不支持任務附件上傳（列入路線圖）
10. **多語言**: 假設系統僅支持繁體中文界面（國際化為未來功能）

---

## Out of Scope (當前版本不包含)

為了明確邊界，以下功能明確排除在當前規格範圍外：

1. **任務附件上傳**: 不支持上傳圖片、文檔等文件到任務（列入路線圖）
2. **任務評論功能**: 不支持成員在任務下留言討論（列入路線圖）
3. **任務依賴關係**: 不支持設置「任務 A 必須在任務 B 之前完成」的依賴
4. **甘特圖視圖**: 不提供項目管理風格的甘特圖時間軸視圖
5. **子任務/檢查清單**: 不支持在任務內創建子任務或待辦清單
6. **任務模板**: 不支持保存任務模板以便快速創建重複任務（當前使用「重複任務」功能部分替代）
7. **數據導出**: 不支持導出任務為 Excel/CSV 格式（列入路線圖）
8. **移動端 APP**: 當前僅提供響應式 Web 界面，不開發原生 iOS/Android 應用
9. **第三方集成**: 不支持與 Google Calendar、Outlook、Slack 等第三方服務集成
10. **任務標籤系統**: 不支持為任務添加多個標籤（當前僅支持單一類別）
